<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Licytacja - ${nazwa}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Helvetica, sans-serif;
            margin:0;
            background:url('https://source.unsplash.com/random/1920x1080?texture') no-repeat center center fixed;
            background-size:cover;
            color:white;
        }
        .overlay {
            backdrop-filter: blur(8px);
            background: rgba(0,0,0,0.7);
            min-height:100vh;
            padding:2em;
        }
        .card {
            background: rgba(30,30,45,0.85);
            padding:1.5em 2em;
            border-radius:12px;
            max-width:650px;
            margin:auto;
            box-shadow:0 10px 30px rgba(0,0,0,0.4);
        }
        h1,h2,h3 { color:#ffd700; margin-top:0; text-align:center; }
        ul { padding-left:1em; list-style:none; }
        li { margin-bottom:0.5em; }
        .new-bid { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }
        #countdown {
            font-size:4em;
            margin-bottom:1em;
            animation:pulse 1s infinite;
            text-align:center;
            font-weight:bold;
        }
        #winner {
            font-size:2em;
            font-weight:bold;
            text-align:center;
        }
        #countdown.red { color:red; }
        #price {
            font-size:6em;
            text-align:center;
            color:#00ff90;
            position:relative;
        }
        #price.up::after {
            content:'\25B2';
            color:#00ff90;
            position:absolute;
            right:-0.6em;
            top:0;
            animation:rise 0.6s ease-out;
        }
        @keyframes rise {
            0% {transform:translateY(10px); opacity:0;}
            100% {transform:translateY(-10px); opacity:1;}
        }
        @keyframes pulse {
            0% { transform:scale(1); }
            50% { transform:scale(1.1); }
            100% { transform:scale(1); }
        }
    </style>
</head>
<body onload="startUpdates()">
<div class="overlay">
    <div class="card" id="auction">
        <h1 id="title">${nazwa} (${numer})</h1>
        <p id="desc">${opis}</p>
        <img id="card-img" src="${obraz}" style="max-width:100%;display:none"/>
        <h2 id="price">${cena} PLN</h2>
        <div id="countdown"></div>
        <h3 id="winner" style="display:none"></h3>
        <h4>Historia licytacji:</h4>
        <ul id="history">
            ${historia}
        </ul>
        <div id="history-nav" style="text-align:center;margin-top:1em;display:none;">
            <button id="history-prev" onclick="prevPage()" style="display:none">&laquo; Poprzednie</button>
            <button id="history-next" onclick="nextPage()" style="display:none">Następne &raquo;</button>
        </div>
    </div>
</div>
<script>
let historyData = [];
let historyPage = 0;
const perPage = 5;
let started = false;
let lastStart = null;
let lastPrice = null;
function startUpdates(){
    started = true;
    fetchData();
    setInterval(fetchData,3000);
    setInterval(updateCountdown,1000);
}
function fetchData(){
    fetch('aktualna_aukcja.json',{cache:'no-cache'}).then(r=>r.json()).then(data=>{
        const list = document.getElementById('history');
        const img = document.getElementById('card-img');

        if(!lastStart || lastStart !== data.start_time){
            historyData = [];
            historyPage = 0;
            end = null;
            document.getElementById('winner').style.display='none';
            document.getElementById('desc').style.display='block';
            document.getElementById('price').style.display='block';
            document.getElementById('history').style.display='block';
            document.getElementById('history-nav').style.display='block';
            lastPrice = null;
            lastStart = data.start_time;
            renderHistory();
        }

        document.getElementById('title').textContent = data.nazwa + ' (' + data.numer + ')';
        document.getElementById('desc').textContent = data.opis;
        const priceEl = document.getElementById('price');
        priceEl.textContent = data.ostateczna_cena.toFixed(2) + ' PLN';
        if(lastPrice !== null && data.ostateczna_cena > lastPrice){
            priceEl.classList.add('up');
            setTimeout(()=>priceEl.classList.remove('up'),600);
        }
        lastPrice = data.ostateczna_cena;

        if(data.obraz){
            img.src = data.obraz;
            img.style.display = 'block';
        }
        if(data.historia){
            historyData = data.historia;
            if(historyPage * perPage >= historyData.length){
                historyPage = Math.max(Math.ceil(historyData.length / perPage) - 1, 0);
            }
            renderHistory();
        }
        auctionData = data;
        if(data.start_time){
            end = new Date(Date.parse(data.start_time) + data.czas*1000);
        }
    }).catch(()=>{});
}
let end = null;
let auctionData = null;
function updateCountdown(){
    if(!started) return;
    if(!end && auctionData && auctionData.start_time){
        end = new Date(Date.parse(auctionData.start_time) + auctionData.czas*1000);
    }
    const now = new Date();
    const diff = Math.floor((end - now)/1000);
    const div = document.getElementById('countdown');
    if(diff <= 10) div.classList.add('red');
    if(diff <= 0){
        div.textContent = 'KONIEC';
        if(auctionData && auctionData.zwyciezca){
            showWinner(auctionData);
        }
    }else{
        div.textContent = diff + ' s';
    }
}
function showWinner(data){
    document.getElementById('winner').style.display='block';
    document.getElementById('winner').textContent = 'Gratulacje! Aukcję wygrał: ' + data.zwyciezca + ' - ' + data.nazwa;
    document.getElementById('desc').style.display='none';
    document.getElementById('price').style.display='none';
    document.getElementById('history').style.display='none';
    document.getElementById('history-nav').style.display='none';
    document.getElementById('history').innerHTML='';
}

function renderHistory(){
    const list = document.getElementById('history');
    list.innerHTML = '';
    const start = historyPage * perPage;
    const slice = historyData.slice(start, start + perPage);
    for(const [u,c,t] of slice){
        const li = document.createElement('li');
        li.textContent = `${u} - ${c.toFixed(2)} PLN - ${t}`;
        list.appendChild(li);
    }
    document.getElementById('history-prev').style.display = historyPage > 0 ? 'inline-block' : 'none';
    document.getElementById('history-next').style.display = (start + perPage) < historyData.length ? 'inline-block' : 'none';
}

function nextPage(){
    if((historyPage + 1) * perPage < historyData.length){
        historyPage++;
        renderHistory();
    }
}

function prevPage(){
    if(historyPage > 0){
        historyPage--;
        renderHistory();
    }
}
</script>
</body>
</html>
